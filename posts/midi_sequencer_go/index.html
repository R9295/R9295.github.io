<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Build a Generative MIDI sequencer in Go | Ruebezahl&#39;s dwellings</title>
<meta name="keywords" content="midi, generative, music, go, sequencer">
<meta name="description" content="Introduction Generative music is always fun and engaging, so I decided to build a simple MIDI sequencer to mess around. In this project, the sequencer sends a random note within a given octave every quarter bar (4/4).
Because it&rsquo;s so simple, the code provided will be very easy to extend as you please.
Setup project $ mkdir gen_seq $ cd gen_seq $ go mod init Sequencer $ touch main.go Install dependencies We&rsquo;ll be using gomidi with the rtmidi backend">
<meta name="author" content="">
<link rel="canonical" href="https://R9295.github.io/posts/midi_sequencer_go/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.d7fb4cbf980fe688a21621b06a795933c4e6bb2d4070ec940667af1715d84af2.css" integrity="sha256-1/tMv5gP5oiiFiGwanlZM8Tmuy1AcOyUBmevFxXYSvI=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://R9295.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://R9295.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://R9295.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://R9295.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://R9295.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Build a Generative MIDI sequencer in Go" />
<meta property="og:description" content="Introduction Generative music is always fun and engaging, so I decided to build a simple MIDI sequencer to mess around. In this project, the sequencer sends a random note within a given octave every quarter bar (4/4).
Because it&rsquo;s so simple, the code provided will be very easy to extend as you please.
Setup project $ mkdir gen_seq $ cd gen_seq $ go mod init Sequencer $ touch main.go Install dependencies We&rsquo;ll be using gomidi with the rtmidi backend" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://R9295.github.io/posts/midi_sequencer_go/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-18T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2022-06-18T00:00:00&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Build a Generative MIDI sequencer in Go"/>
<meta name="twitter:description" content="Introduction Generative music is always fun and engaging, so I decided to build a simple MIDI sequencer to mess around. In this project, the sequencer sends a random note within a given octave every quarter bar (4/4).
Because it&rsquo;s so simple, the code provided will be very easy to extend as you please.
Setup project $ mkdir gen_seq $ cd gen_seq $ go mod init Sequencer $ touch main.go Install dependencies We&rsquo;ll be using gomidi with the rtmidi backend"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://R9295.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Build a Generative MIDI sequencer in Go",
      "item": "https://R9295.github.io/posts/midi_sequencer_go/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Build a Generative MIDI sequencer in Go",
  "name": "Build a Generative MIDI sequencer in Go",
  "description": "Introduction Generative music is always fun and engaging, so I decided to build a simple MIDI sequencer to mess around. In this project, the sequencer sends a random note within a given octave every quarter bar (4/4).\nBecause it\u0026rsquo;s so simple, the code provided will be very easy to extend as you please.\nSetup project $ mkdir gen_seq $ cd gen_seq $ go mod init Sequencer $ touch main.go Install dependencies We\u0026rsquo;ll be using gomidi with the rtmidi backend",
  "keywords": [
    "midi", "generative", "music", "go", "sequencer"
  ],
  "articleBody": "Introduction Generative music is always fun and engaging, so I decided to build a simple MIDI sequencer to mess around. In this project, the sequencer sends a random note within a given octave every quarter bar (4/4).\nBecause it’s so simple, the code provided will be very easy to extend as you please.\nSetup project $ mkdir gen_seq $ cd gen_seq $ go mod init Sequencer $ touch main.go Install dependencies We’ll be using gomidi with the rtmidi backend\n$ go get gitlab.com/gomidi/midi/v2@latest Create MIDI ports We need to create:\nMIDI-in to sync our sequencer with the master clock MIDI-out for the sequencer to send notes to. // main.go package main import ( \"fmt\" \"gitlab.com/gomidi/midi/v2/drivers/rtmididrv\" ) func main() { driver, err := rtmididrv.New() if err != nil { panic(err) } defer driver.Close() inPort, err := driver.OpenVirtualIn(\"sequencer_in\") outPort, err := driver.OpenVirtualOut(\"sequencer_out\") if err != nil { panic(err) } // Need to use the iables otherwise the code won't compile fmt.Println(inPort, outPort) } Note:\nif you’re using a synth instead of a VST, you can set the outPort to the synth directly. I use the Korg Monologue.\n$ amidi -l Dir Device Name IO hw:0,0 Virtual Raw MIDI (16 subdevices) IO hw:0,1 Virtual Raw MIDI (16 subdevices) IO hw:0,2 Virtual Raw MIDI (16 subdevices) IO hw:0,3 Virtual Raw MIDI (16 subdevices) IO hw:4,0,0 monologue MIDI 1 IO hw:4,0,1 monologue MIDI 2 package main import ( \"fmt\" \"gitlab.com/gomidi/midi/v2\" \"gitlab.com/gomidi/midi/v2/drivers/rtmididrv\" _\"gitlab.com/gomidi/midi/v2/drivers/rtmididrv\" // autoregisters driver ) func main() { driver, err := rtmididrv.New() if err != nil { panic(err) } defer driver.Close() inPort, err := driver.OpenVirtualIn(\"sequencer_in\") outPort, err := midi.FindOutPort(\"monologue MIDI 1\") if err != nil { panic(err) } // Need to use the iables otherwise the code won't compile fmt.Println(inPort, outPort) } You can follow the rest of the tutorial as-is with these changes. Just make sure the new imports remain.\nLet’s see if it works\n$ go build $ ./Sequencer sequencer_in sequencer_out # Nice! Get clock data MIDI clock is essential for a sequencer. We need to stay in sync with other instruments and sequence notes at the right time. According to the MIDI clock specification, a quarter of a bar has 24 pulses.\npackage main import ( \"fmt\" \"gitlab.com/gomidi/midi/v2/drivers/rtmididrv\" ) func main() { driver, err := rtmididrv.New() if err != nil { panic(err) } defer driver.Close() inPort, err := driver.OpenVirtualIn(\"sequencer_in\") outPort, err := driver.OpenVirtualOut(\"sequencer_out\") if err != nil { panic(err) } fmt.Println(inPort, outPort) pulses := 0 pulsesPerQuarter := 24 pulsesPerBar := pulsesPerQuarter * 4 // assuming it's 4/4 bars := 1 } Now let’s read clock data from sequencer_in.\npackage main import ( \"fmt\" \"gitlab.com/gomidi/midi/v2\" \"gitlab.com/gomidi/midi/v2/drivers/rtmididrv\" _ \"gitlab.com/gomidi/midi/v2/drivers/rtmididrv\" // autoregisters driver ) func main() { driver, err := rtmididrv.New() if err != nil { panic(err) } defer driver.Close() inPort, err := driver.OpenVirtualIn(\"sequencer_in\") outPort, err := driver.OpenVirtualOut(\"sequencer_out\") if err != nil { panic(err) } fmt.Println(inPort, outPort) pulses := 0 pulsesPerQuarter := 24 pulsesPerBar := pulsesPerQuarter * 4 // assuming it's 4/4 bars := 1 _, err = midi.ListenTo(inPort, func(msg midi.Message, timestampms int32) { switch msg.Type() { case midi.TimingClockMsg: // a \"timing message\" is a \"pulse\" pulses++ if pulses == pulsesPerBar { // reset pulses every bar bars++ pulses = 0 fmt.Printf(\"Bar %d\\n\", bars) } case midi.StopMsg: // if we get a stop message, reset our counters pulses = 0 bars = 1 } }, midi.UseTimeCode()) // we declare that we only want timecode messages if err != nil { panic(err) } // infinite loop to listen to messages forever for true {} } Lets try it out!\n$ go build $ ./Sequencer Open your DAW, in my case it’s Ardour. You should see the sequencer_in ports in your MIDI settings.\nSet MIDI clock out to sequencer_in\nPress play in your DAW and if all goes well, you should see the bars printing in your terminal.\nNice!\nPlay random notes Now, let’s add a getRandomNote function\npackage main import ( \"fmt\" \"math/rand\" \"time\" \"gitlab.com/gomidi/midi/v2\" \"gitlab.com/gomidi/midi/v2/drivers/rtmididrv\" _ \"gitlab.com/gomidi/midi/v2/drivers/rtmididrv\" // autoregisters driver ) func getRandomInt(a int, b int) uint8 { rand.Seed(time.Now().UnixNano()) return uint8(a + rand.Intn(b-a+1)) } func getRandomNote(octave uint8) uint8 { notes := [12]uint8{ midi.C(octave), midi.Db(octave), midi.D(octave), midi.Eb(octave), midi.E(octave), midi.F(octave), midi.Gb(octave), midi.G(octave), midi.Ab(octave), midi.A(octave), midi.Bb(octave), midi.B(octave), } return notes[getRandomInt(0, 11)] } func main() { driver, err := rtmididrv.New() if err != nil { panic(err) } defer driver.Close() inPort, err := driver.OpenVirtualIn(\"sequencer_in\") outPort, err := driver.OpenVirtualOut(\"sequencer_out\") if err != nil { panic(err) } fmt.Println(inPort, outPort) pulses := 0 pulsesPerQuarter := 24 pulsesPerBar := pulsesPerQuarter * 4 // assuming it's 4/4 bars := 1 // add from here _, err = midi.ListenTo(inPort, func(msg midi.Message, timestampms int32) { switch msg.Type() { case midi.TimingClockMsg: // a \"timing message\" is a \"pulse\" pulses++ if pulses == pulsesPerBar { // reset pulses every bar bars++ pulses = 0 fmt.Printf(\"Bar %d\\n\", bars) } case midi.StopMsg: // if we get a stop message, reset our counters pulses = 0 bars = 1 } }, midi.UseTimeCode()) // we declare that we only want timecode messages if err != nil { panic(err) } // infinite loop to listen to messages forever for true {} } Now, let’s play a random note every quarter of a bar\npackage main import ( \"fmt\" \"math/rand\" \"time\" \"gitlab.com/gomidi/midi/v2\" \"gitlab.com/gomidi/midi/v2/drivers/rtmididrv\" _ \"gitlab.com/gomidi/midi/v2/drivers/rtmididrv\" // autoregisters driver ) func getRandomInt(a int, b int) uint8 { rand.Seed(time.Now().UnixNano()) return uint8(a + rand.Intn(b-a+1)) } func getRandomNote(octave uint8) uint8 { notes := [12]uint8{ midi.C(octave), midi.Db(octave), midi.D(octave), midi.Eb(octave), midi.E(octave), midi.F(octave), midi.Gb(octave), midi.G(octave), midi.Ab(octave), midi.A(octave), midi.Bb(octave), midi.B(octave), } return notes[getRandomInt(0, 11)] } func isPulseQuarter(pulse int) bool { // Remember that every quarter bar is 24 pulses if pulse % 24 == 0 { return true } return false } func main() { driver, err := rtmididrv.New() if err != nil { panic(err) } defer driver.Close() inPort, err := driver.OpenVirtualIn(\"sequencer_in\") outPort, err := driver.OpenVirtualOut(\"sequencer_out\") if err != nil { panic(err) } fmt.Println(inPort, outPort) pulses := 0 pulsesPerQuarter := 24 pulsesPerBar := pulsesPerQuarter * 4 // assuming it's 4/4 bars := 1 var midiChannel uint8 = 1 previousNote := getRandomNote(3) _, err = midi.ListenTo(inPort, func(msg midi.Message, timestampms int32) { switch msg.Type() { case midi.TimingClockMsg: // a \"timing message\" is a \"pulse\" pulses++ if pulses == pulsesPerBar { // reset pulses every bar bars++ pulses = 0 fmt.Printf(\"Bar %d\\n\", bars) } if isPulseQuarter(pulses) { note := getRandomNote(3) fmt.Printf(\"playing note %d\\n\", note) // send Note Off message before sending new note outPort.Send(midi.NoteOff(midiChannel, previousNote)) // channel 1, velocity 127 outPort.Send(midi.NoteOn(midiChannel, note, 127)) previousNote = note } case midi.StopMsg: // if we get a stop message, reset our counters pulses = 0 bars = 1 } }, midi.UseTimeCode()) // we declare that we only want timecode messages if err != nil { panic(err) } // infinite loop to listen to messages forever for true {} } Voila! Let’s compile and run this\n$ go build $ ./Sequencer # press play from your DAW And you should see… Make sure:\nTo adjust the midiChannel parameter in midi.NoteOn and midi.NoteOff if your synth/VST takes input from another MIDI channel. Reflections The code can definitely be cleaner, but I feel that the way it is written makes it fairly easy to understand.\nReferences gomidi docs\nrtmididrv docs\nBonus Decide whether to play or not When checking if pulseIsQuarter to see if we should play, we can add another conditional\nif isPulseQuarter(pulses) \u0026\u0026 getRandomInt(0, 1) == 1 { note := getRandomNote(3) // .... Arpeggiator Modify the isPulseQuarter function\nfunc isPulseQuarter(pulse int) bool { // Try changing the 24 to 6 or 12 if pulse % 24 == 0 { return true } return false } Random octave When calling getRandomNote, we supply an octave paramter. Let’s make that random (within a range)\nif isPulseQuarter(pulses) { note := getRandomNote(getRandomInt(3, 6)) // ..... ",
  "wordCount" : "1272",
  "inLanguage": "en",
  "datePublished": "2022-06-18T00:00:00Z",
  "dateModified": "2022-06-18T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://R9295.github.io/posts/midi_sequencer_go/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Ruebezahl's dwellings",
    "logo": {
      "@type": "ImageObject",
      "url": "https://R9295.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class=" dark
" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://R9295.github.io" accesskey="h" title="Ruebezahl&#39;s dwellings (Alt + H)">Ruebezahl&#39;s dwellings</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://R9295.github.io/about/" title="About">
                    <span>About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Build a Generative MIDI sequencer in Go
    </h1>
    <div class="post-meta"><span title='2022-06-18 00:00:00 +0000 UTC'>June 18, 2022</span>

</div>
  </header> 
  <div class="post-content"><h2 id="introduction">Introduction<a hidden class="anchor" aria-hidden="true" href="#introduction">#</a></h2>
<p>Generative music is always fun and engaging, so I decided to build a simple MIDI sequencer to mess around.
In this project, the sequencer sends a random note within a given octave every quarter bar (4/4).<br>
Because it&rsquo;s so simple, the code provided will be very easy to extend as you please.</p>
<h2 id="setup-project">Setup project<a hidden class="anchor" aria-hidden="true" href="#setup-project">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ mkdir gen_seq
</span></span><span style="display:flex;"><span>$ cd gen_seq
</span></span><span style="display:flex;"><span>$ go mod init Sequencer
</span></span><span style="display:flex;"><span>$ touch main.go
</span></span></code></pre></div><h2 id="install-dependencies">Install dependencies<a hidden class="anchor" aria-hidden="true" href="#install-dependencies">#</a></h2>
<p>We&rsquo;ll be using <a href="https://gitlab.com/gomidi/midi/">gomidi</a> with the <a href="https://github.com/thestk/rtmidi">rtmidi</a> backend</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ go get gitlab.com/gomidi/midi/v2@latest
</span></span></code></pre></div><h2 id="create-midi-ports">Create MIDI ports<a hidden class="anchor" aria-hidden="true" href="#create-midi-ports">#</a></h2>
<p>We need to create:</p>
<ol>
<li>MIDI-in to sync our sequencer with the master clock</li>
<li>MIDI-out for the sequencer to send notes to.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// main.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;gitlab.com/gomidi/midi/v2/drivers/rtmididrv&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">driver</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rtmididrv</span>.<span style="color:#a6e22e">New</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">driver</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">inPort</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">driver</span>.<span style="color:#a6e22e">OpenVirtualIn</span>(<span style="color:#e6db74">&#34;sequencer_in&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">outPort</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">driver</span>.<span style="color:#a6e22e">OpenVirtualOut</span>(<span style="color:#e6db74">&#34;sequencer_out&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Need to use the iables otherwise the code won&#39;t compile
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">inPort</span>, <span style="color:#a6e22e">outPort</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Note:<br>
if you&rsquo;re using a synth instead of a VST, you can set the <code>outPort</code> to the synth directly. I use the Korg Monologue.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ amidi -l
</span></span><span style="display:flex;"><span>Dir Device    Name
</span></span><span style="display:flex;"><span>IO  hw:0,0    Virtual Raw MIDI <span style="color:#f92672">(</span><span style="color:#ae81ff">16</span> subdevices<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>IO  hw:0,1    Virtual Raw MIDI <span style="color:#f92672">(</span><span style="color:#ae81ff">16</span> subdevices<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>IO  hw:0,2    Virtual Raw MIDI <span style="color:#f92672">(</span><span style="color:#ae81ff">16</span> subdevices<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>IO  hw:0,3    Virtual Raw MIDI <span style="color:#f92672">(</span><span style="color:#ae81ff">16</span> subdevices<span style="color:#f92672">)</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>IO  hw:4,0,0  monologue MIDI <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>IO  hw:4,0,1  monologue MIDI <span style="color:#ae81ff">2</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>	<span style="color:#e6db74">&#34;gitlab.com/gomidi/midi/v2&#34;</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;gitlab.com/gomidi/midi/v2/drivers/rtmididrv&#34;</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>	<span style="color:#a6e22e">_</span><span style="color:#e6db74">&#34;gitlab.com/gomidi/midi/v2/drivers/rtmididrv&#34;</span> <span style="color:#75715e">// autoregisters driver
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">driver</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rtmididrv</span>.<span style="color:#a6e22e">New</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">driver</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">inPort</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">driver</span>.<span style="color:#a6e22e">OpenVirtualIn</span>(<span style="color:#e6db74">&#34;sequencer_in&#34;</span>)
</span></span><span style="display:flex; background-color:#3c3d38"><span>	<span style="color:#a6e22e">outPort</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">FindOutPort</span>(<span style="color:#e6db74">&#34;monologue MIDI 1&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Need to use the iables otherwise the code won&#39;t compile
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">inPort</span>, <span style="color:#a6e22e">outPort</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>You can follow the rest of the tutorial as-is with these changes. Just make sure the new imports remain.</p>
<p>Let&rsquo;s see if it works</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ go build
</span></span><span style="display:flex;"><span>$ ./Sequencer
</span></span><span style="display:flex;"><span>sequencer_in sequencer_out
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Nice!</span>
</span></span></code></pre></div><h2 id="get-clock-data">Get clock data<a hidden class="anchor" aria-hidden="true" href="#get-clock-data">#</a></h2>
<p>MIDI clock is essential for a sequencer.
We need to stay in sync with other instruments and sequence notes at the right time.
According to the <a href="https://en.wikipedia.org/wiki/MIDI_beat_clock">MIDI clock specification</a>, a <strong>quarter</strong> of a bar has <strong>24 pulses</strong>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;gitlab.com/gomidi/midi/v2/drivers/rtmididrv&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">driver</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rtmididrv</span>.<span style="color:#a6e22e">New</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">driver</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">inPort</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">driver</span>.<span style="color:#a6e22e">OpenVirtualIn</span>(<span style="color:#e6db74">&#34;sequencer_in&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">outPort</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">driver</span>.<span style="color:#a6e22e">OpenVirtualOut</span>(<span style="color:#e6db74">&#34;sequencer_out&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">inPort</span>, <span style="color:#a6e22e">outPort</span>)
</span></span><span style="display:flex; background-color:#3c3d38"><span>	<span style="color:#a6e22e">pulses</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>	<span style="color:#a6e22e">pulsesPerQuarter</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">24</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>	<span style="color:#a6e22e">pulsesPerBar</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pulsesPerQuarter</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span> <span style="color:#75715e">// assuming it&#39;s 4/4
</span></span></span><span style="display:flex; background-color:#3c3d38"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">bars</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Now let&rsquo;s <strong>read clock data</strong> from <code>sequencer_in</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;gitlab.com/gomidi/midi/v2&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;gitlab.com/gomidi/midi/v2/drivers/rtmididrv&#34;</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>	<span style="color:#a6e22e">_</span> <span style="color:#e6db74">&#34;gitlab.com/gomidi/midi/v2/drivers/rtmididrv&#34;</span> <span style="color:#75715e">// autoregisters driver
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">driver</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rtmididrv</span>.<span style="color:#a6e22e">New</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">driver</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">inPort</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">driver</span>.<span style="color:#a6e22e">OpenVirtualIn</span>(<span style="color:#e6db74">&#34;sequencer_in&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">outPort</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">driver</span>.<span style="color:#a6e22e">OpenVirtualOut</span>(<span style="color:#e6db74">&#34;sequencer_out&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">inPort</span>, <span style="color:#a6e22e">outPort</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">pulses</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">pulsesPerQuarter</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">24</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">pulsesPerBar</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pulsesPerQuarter</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span> <span style="color:#75715e">// assuming it&#39;s 4/4
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">bars</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">ListenTo</span>(<span style="color:#a6e22e">inPort</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">msg</span> <span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">Message</span>, <span style="color:#a6e22e">timestampms</span> <span style="color:#66d9ef">int32</span>) {
</span></span><span style="display:flex; background-color:#3c3d38"><span>		<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Type</span>() {
</span></span><span style="display:flex; background-color:#3c3d38"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">TimingClockMsg</span>:
</span></span><span style="display:flex; background-color:#3c3d38"><span>			<span style="color:#75715e">// a &#34;timing message&#34; is a &#34;pulse&#34;
</span></span></span><span style="display:flex; background-color:#3c3d38"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">pulses</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">pulses</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">pulsesPerBar</span> {
</span></span><span style="display:flex; background-color:#3c3d38"><span>				<span style="color:#75715e">// reset pulses every bar
</span></span></span><span style="display:flex; background-color:#3c3d38"><span><span style="color:#75715e"></span>				<span style="color:#a6e22e">bars</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>				<span style="color:#a6e22e">pulses</span> = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Bar %d\n&#34;</span>, <span style="color:#a6e22e">bars</span>)
</span></span><span style="display:flex; background-color:#3c3d38"><span>			}
</span></span><span style="display:flex; background-color:#3c3d38"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">StopMsg</span>:
</span></span><span style="display:flex; background-color:#3c3d38"><span>			<span style="color:#75715e">// if we get a stop message, reset our counters
</span></span></span><span style="display:flex; background-color:#3c3d38"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">pulses</span> = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>			<span style="color:#a6e22e">bars</span> = <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>		}
</span></span><span style="display:flex; background-color:#3c3d38"><span>	}, <span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">UseTimeCode</span>()) <span style="color:#75715e">// we declare that we only want timecode messages
</span></span></span><span style="display:flex; background-color:#3c3d38"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex; background-color:#3c3d38"><span>		panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex; background-color:#3c3d38"><span>	}
</span></span><span style="display:flex; background-color:#3c3d38"><span>	<span style="color:#75715e">// infinite loop to listen to messages forever
</span></span></span><span style="display:flex; background-color:#3c3d38"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#66d9ef">true</span> {}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Lets try it out!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ go build
</span></span><span style="display:flex;"><span>$ ./Sequencer
</span></span></code></pre></div><p>Open your DAW, in my case it&rsquo;s <a href="https://ardour.org/">Ardour</a>. You should see the <code>sequencer_in</code> ports in your MIDI settings.<br>
<img loading="lazy" src="/images/posts/midi_sequencer_go/show_seq_in.png" alt="MIDI Port"  />
<br>
Set MIDI clock out to <code>sequencer_in</code><br>
<img loading="lazy" src="/images/posts/midi_sequencer_go/set_midi_clock_out.png" alt="Set MIDI clock out"  />
<br>
Press play in your DAW and if all goes well, you should see the bars printing in your terminal.<br>
<img loading="lazy" src="/images/posts/midi_sequencer_go/msgs.png" alt="Bar messages"  />
</p>
<p><strong>Nice!</strong></p>
<h2 id="play-random-notes">Play random notes<a hidden class="anchor" aria-hidden="true" href="#play-random-notes">#</a></h2>
<p>Now, let&rsquo;s add a <code>getRandomNote</code> function</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>	<span style="color:#e6db74">&#34;math/rand&#34;</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>	<span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;gitlab.com/gomidi/midi/v2&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;gitlab.com/gomidi/midi/v2/drivers/rtmididrv&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">_</span> <span style="color:#e6db74">&#34;gitlab.com/gomidi/midi/v2/drivers/rtmididrv&#34;</span> <span style="color:#75715e">// autoregisters driver
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex; background-color:#3c3d38"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getRandomInt</span>(<span style="color:#a6e22e">a</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">b</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">uint8</span> {
</span></span><span style="display:flex; background-color:#3c3d38"><span>	<span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Seed</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">UnixNano</span>())
</span></span><span style="display:flex; background-color:#3c3d38"><span>	<span style="color:#66d9ef">return</span> uint8(<span style="color:#a6e22e">a</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Intn</span>(<span style="color:#a6e22e">b</span><span style="color:#f92672">-</span><span style="color:#a6e22e">a</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex; background-color:#3c3d38"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex; background-color:#3c3d38"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getRandomNote</span>(<span style="color:#a6e22e">octave</span> <span style="color:#66d9ef">uint8</span>) <span style="color:#66d9ef">uint8</span> {
</span></span><span style="display:flex; background-color:#3c3d38"><span>	<span style="color:#a6e22e">notes</span> <span style="color:#f92672">:=</span> [<span style="color:#ae81ff">12</span>]<span style="color:#66d9ef">uint8</span>{
</span></span><span style="display:flex; background-color:#3c3d38"><span>		<span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">C</span>(<span style="color:#a6e22e">octave</span>),
</span></span><span style="display:flex; background-color:#3c3d38"><span>		<span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">Db</span>(<span style="color:#a6e22e">octave</span>),
</span></span><span style="display:flex; background-color:#3c3d38"><span>		<span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">D</span>(<span style="color:#a6e22e">octave</span>),
</span></span><span style="display:flex; background-color:#3c3d38"><span>		<span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">Eb</span>(<span style="color:#a6e22e">octave</span>),
</span></span><span style="display:flex; background-color:#3c3d38"><span>		<span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">E</span>(<span style="color:#a6e22e">octave</span>),
</span></span><span style="display:flex; background-color:#3c3d38"><span>		<span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">F</span>(<span style="color:#a6e22e">octave</span>),
</span></span><span style="display:flex; background-color:#3c3d38"><span>		<span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">Gb</span>(<span style="color:#a6e22e">octave</span>),
</span></span><span style="display:flex; background-color:#3c3d38"><span>		<span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">G</span>(<span style="color:#a6e22e">octave</span>),
</span></span><span style="display:flex; background-color:#3c3d38"><span>		<span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">Ab</span>(<span style="color:#a6e22e">octave</span>),
</span></span><span style="display:flex; background-color:#3c3d38"><span>		<span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">A</span>(<span style="color:#a6e22e">octave</span>),
</span></span><span style="display:flex; background-color:#3c3d38"><span>		<span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">Bb</span>(<span style="color:#a6e22e">octave</span>),
</span></span><span style="display:flex; background-color:#3c3d38"><span>		<span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">B</span>(<span style="color:#a6e22e">octave</span>),
</span></span><span style="display:flex; background-color:#3c3d38"><span>	}
</span></span><span style="display:flex; background-color:#3c3d38"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">notes</span>[<span style="color:#a6e22e">getRandomInt</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">11</span>)]
</span></span><span style="display:flex; background-color:#3c3d38"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">driver</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rtmididrv</span>.<span style="color:#a6e22e">New</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">driver</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">inPort</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">driver</span>.<span style="color:#a6e22e">OpenVirtualIn</span>(<span style="color:#e6db74">&#34;sequencer_in&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">outPort</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">driver</span>.<span style="color:#a6e22e">OpenVirtualOut</span>(<span style="color:#e6db74">&#34;sequencer_out&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">inPort</span>, <span style="color:#a6e22e">outPort</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">pulses</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">pulsesPerQuarter</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">24</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">pulsesPerBar</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pulsesPerQuarter</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span> <span style="color:#75715e">// assuming it&#39;s 4/4
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">bars</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// add from here
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">ListenTo</span>(<span style="color:#a6e22e">inPort</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">msg</span> <span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">Message</span>, <span style="color:#a6e22e">timestampms</span> <span style="color:#66d9ef">int32</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Type</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">TimingClockMsg</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// a &#34;timing message&#34; is a &#34;pulse&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">pulses</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">pulses</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">pulsesPerBar</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// reset pulses every bar
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#a6e22e">bars</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">pulses</span> = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Bar %d\n&#34;</span>, <span style="color:#a6e22e">bars</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">StopMsg</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// if we get a stop message, reset our counters
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">pulses</span> = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">bars</span> = <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}, <span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">UseTimeCode</span>()) <span style="color:#75715e">// we declare that we only want timecode messages
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// infinite loop to listen to messages forever
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#66d9ef">true</span> {}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Now, let&rsquo;s play a random note every <strong>quarter of a bar</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;math/rand&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;gitlab.com/gomidi/midi/v2&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;gitlab.com/gomidi/midi/v2/drivers/rtmididrv&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">_</span> <span style="color:#e6db74">&#34;gitlab.com/gomidi/midi/v2/drivers/rtmididrv&#34;</span> <span style="color:#75715e">// autoregisters driver
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getRandomInt</span>(<span style="color:#a6e22e">a</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">b</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">uint8</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Seed</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">UnixNano</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> uint8(<span style="color:#a6e22e">a</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Intn</span>(<span style="color:#a6e22e">b</span><span style="color:#f92672">-</span><span style="color:#a6e22e">a</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getRandomNote</span>(<span style="color:#a6e22e">octave</span> <span style="color:#66d9ef">uint8</span>) <span style="color:#66d9ef">uint8</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">notes</span> <span style="color:#f92672">:=</span> [<span style="color:#ae81ff">12</span>]<span style="color:#66d9ef">uint8</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">C</span>(<span style="color:#a6e22e">octave</span>),
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">Db</span>(<span style="color:#a6e22e">octave</span>),
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">D</span>(<span style="color:#a6e22e">octave</span>),
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">Eb</span>(<span style="color:#a6e22e">octave</span>),
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">E</span>(<span style="color:#a6e22e">octave</span>),
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">F</span>(<span style="color:#a6e22e">octave</span>),
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">Gb</span>(<span style="color:#a6e22e">octave</span>),
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">G</span>(<span style="color:#a6e22e">octave</span>),
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">Ab</span>(<span style="color:#a6e22e">octave</span>),
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">A</span>(<span style="color:#a6e22e">octave</span>),
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">Bb</span>(<span style="color:#a6e22e">octave</span>),
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">B</span>(<span style="color:#a6e22e">octave</span>),
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">notes</span>[<span style="color:#a6e22e">getRandomInt</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">11</span>)]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex; background-color:#3c3d38"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">isPulseQuarter</span>(<span style="color:#a6e22e">pulse</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex; background-color:#3c3d38"><span>	<span style="color:#75715e">// Remember that every quarter bar is 24 pulses
</span></span></span><span style="display:flex; background-color:#3c3d38"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">pulse</span> <span style="color:#f92672">%</span> <span style="color:#ae81ff">24</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex; background-color:#3c3d38"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>	}
</span></span><span style="display:flex; background-color:#3c3d38"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">driver</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rtmididrv</span>.<span style="color:#a6e22e">New</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">driver</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">inPort</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">driver</span>.<span style="color:#a6e22e">OpenVirtualIn</span>(<span style="color:#e6db74">&#34;sequencer_in&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">outPort</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">driver</span>.<span style="color:#a6e22e">OpenVirtualOut</span>(<span style="color:#e6db74">&#34;sequencer_out&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">inPort</span>, <span style="color:#a6e22e">outPort</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">pulses</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">pulsesPerQuarter</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">24</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">pulsesPerBar</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pulsesPerQuarter</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span> <span style="color:#75715e">// assuming it&#39;s 4/4
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">bars</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">midiChannel</span> <span style="color:#66d9ef">uint8</span> = <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>	<span style="color:#a6e22e">previousNote</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">getRandomNote</span>(<span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">ListenTo</span>(<span style="color:#a6e22e">inPort</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">msg</span> <span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">Message</span>, <span style="color:#a6e22e">timestampms</span> <span style="color:#66d9ef">int32</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Type</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">TimingClockMsg</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// a &#34;timing message&#34; is a &#34;pulse&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">pulses</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">pulses</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">pulsesPerBar</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// reset pulses every bar
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#a6e22e">bars</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">pulses</span> = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Bar %d\n&#34;</span>, <span style="color:#a6e22e">bars</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex; background-color:#3c3d38"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">isPulseQuarter</span>(<span style="color:#a6e22e">pulses</span>) {
</span></span><span style="display:flex; background-color:#3c3d38"><span>				<span style="color:#a6e22e">note</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">getRandomNote</span>(<span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex; background-color:#3c3d38"><span>				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;playing note %d\n&#34;</span>, <span style="color:#a6e22e">note</span>)
</span></span><span style="display:flex; background-color:#3c3d38"><span>				<span style="color:#75715e">// send Note Off message before sending new note
</span></span></span><span style="display:flex; background-color:#3c3d38"><span><span style="color:#75715e"></span>				<span style="color:#a6e22e">outPort</span>.<span style="color:#a6e22e">Send</span>(<span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">NoteOff</span>(<span style="color:#a6e22e">midiChannel</span>, <span style="color:#a6e22e">previousNote</span>))
</span></span><span style="display:flex; background-color:#3c3d38"><span>				<span style="color:#75715e">// channel 1, velocity 127
</span></span></span><span style="display:flex; background-color:#3c3d38"><span><span style="color:#75715e"></span>				<span style="color:#a6e22e">outPort</span>.<span style="color:#a6e22e">Send</span>(<span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">NoteOn</span>(<span style="color:#a6e22e">midiChannel</span>, <span style="color:#a6e22e">note</span>, <span style="color:#ae81ff">127</span>))
</span></span><span style="display:flex; background-color:#3c3d38"><span>				<span style="color:#a6e22e">previousNote</span> = <span style="color:#a6e22e">note</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>			}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">StopMsg</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// if we get a stop message, reset our counters
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">pulses</span> = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">bars</span> = <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}, <span style="color:#a6e22e">midi</span>.<span style="color:#a6e22e">UseTimeCode</span>()) <span style="color:#75715e">// we declare that we only want timecode messages
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// infinite loop to listen to messages forever
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#66d9ef">true</span> {}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Voila!
Let&rsquo;s compile and run this</p>
<pre tabindex="0"><code>$ go build 
$ ./Sequencer
# press play from your DAW
</code></pre><p>And you should see&hellip;
<img loading="lazy" src="/images/posts/midi_sequencer_go/playing_note.png" alt="Playing Note"  />
</p>
<p>Make sure:</p>
<ol>
<li>To adjust the <code>midiChannel</code> parameter in <code>midi.NoteOn</code> and <code>midi.NoteOff</code> if your synth/VST takes input from another MIDI channel.</li>
</ol>
<h2 id="reflections">Reflections<a hidden class="anchor" aria-hidden="true" href="#reflections">#</a></h2>
<p>The code can definitely be cleaner, but I feel that the way it is written makes it fairly easy to understand.</p>
<h2 id="references">References<a hidden class="anchor" aria-hidden="true" href="#references">#</a></h2>
<p><a href="https://pkg.go.dev/gitlab.com/gomidi/midi/v2">gomidi docs</a><br>
<a href="https://pkg.go.dev/gitlab.com/gomidi/midi/v2/drivers/rtmididrv">rtmididrv docs</a></p>
<h2 id="bonus">Bonus<a hidden class="anchor" aria-hidden="true" href="#bonus">#</a></h2>
<h3 id="decide-whether-to-play-or-not">Decide whether to play or not<a hidden class="anchor" aria-hidden="true" href="#decide-whether-to-play-or-not">#</a></h3>
<p>When checking if <code>pulseIsQuarter</code> to see if we should play, we can add another conditional</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">isPulseQuarter</span>(<span style="color:#a6e22e">pulses</span>) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">getRandomInt</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">note</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">getRandomNote</span>(<span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ....
</span></span></span></code></pre></div><h3 id="arpeggiator">Arpeggiator<a hidden class="anchor" aria-hidden="true" href="#arpeggiator">#</a></h3>
<p>Modify the <code>isPulseQuarter</code> function</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">isPulseQuarter</span>(<span style="color:#a6e22e">pulse</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Try changing the 24 to 6 or 12
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">pulse</span> <span style="color:#f92672">%</span> <span style="color:#ae81ff">24</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="random-octave">Random octave<a hidden class="anchor" aria-hidden="true" href="#random-octave">#</a></h3>
<p>When calling <code>getRandomNote</code>, we supply an octave paramter.
Let&rsquo;s make that random (within a range)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">isPulseQuarter</span>(<span style="color:#a6e22e">pulses</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">note</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">getRandomNote</span>(<span style="color:#a6e22e">getRandomInt</span>(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">6</span>))
</span></span><span style="display:flex;"><span><span style="color:#75715e">// .....
</span></span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://R9295.github.io/tags/midi/">midi</a></li>
      <li><a href="https://R9295.github.io/tags/generative/">generative</a></li>
      <li><a href="https://R9295.github.io/tags/music/">music</a></li>
      <li><a href="https://R9295.github.io/tags/go/">go</a></li>
      <li><a href="https://R9295.github.io/tags/sequencer/">sequencer</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>
        <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">All work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
